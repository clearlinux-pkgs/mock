From 73431cdb3de7df4608f588e4b5690038c4accecd Mon Sep 17 00:00:00 2001
From: "Simental Magana, Marcos" <marcos.simental.magana@intel.com>
Date: Wed, 24 Jan 2018 11:17:28 -0600
Subject: [PATCH] clearlinux stateless configuration

Signed-off-by: Simental Magana, Marcos <marcos.simental.magana@intel.com>
---
 Makefile.am          |  1 +
 docs/mock.1          |  9 ++++++---
 etc/mock/clear.cfg   | 37 +++++++++++++++++++++++++++++++++++++
 py/mock.py           |  7 ++++++-
 py/mockbuild/util.py |  4 ++--
 5 files changed, 52 insertions(+), 6 deletions(-)
 create mode 100644 etc/mock/clear.cfg

diff --git a/Makefile.am b/Makefile.am
index 9ec2687..fbe5d8c 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -28,6 +28,7 @@ CLEANFILES += $(EXTRA_PROGRAMS)
 mocketcdir = $(sysconfdir)/mock
 mocketc_DATA = $(wildcard $(top_srcdir)/etc/mock/epel*.cfg) \
 	       $(wildcard $(top_srcdir)/etc/mock/fedora*.cfg) \
+	       $(wildcard $(top_srcdir)/etc/mock/clear*.cfg) \
 	       $(top_srcdir)/etc/mock/site-defaults.cfg \
 	       $(top_srcdir)/etc/mock/logging.ini
 
diff --git a/docs/mock.1 b/docs/mock.1
index 12ebea7..5dacba9 100644
--- a/docs/mock.1
+++ b/docs/mock.1
@@ -55,8 +55,9 @@ contents specified by a configuration file, then build any input SRPM(s) in
 that chroot.
 .LP
 The content of a chroot is specified by the configuration specified with the
-\fB\-r\fR option. The default configuration file is /etc/mock/default.cfg,
-which is usually a symlink to one of the installed configurations.
+\fB\-r\fR option. The default configuration file is
+/usr/share/defaults/mock/default.cfg, which is usually a symlink to one
+of the installed configurations.
 .LP
 There is a site\-wide configuration file, /etc/mock/site\-defaults.cfg, which can
 be used to specify site\-wide options. The shipped version of this file has no
@@ -324,7 +325,9 @@ Use yum as the current package manager. This is the default.
 
 .SH "FILES"
 .LP
-\fI/etc/mock/\fP \- default configuration directory
+\fI/usr/share/defaults/mock/\fP \- default configuration directory (used when /etc/mock/ is missing)
+.LP
+\fI/etc/mock/\fP \- system configuration directory
 .LP
 \fI/var/lib/mock\fP \- directory where chroots are created
 .SH "EXAMPLES"
diff --git a/etc/mock/clear.cfg b/etc/mock/clear.cfg
new file mode 100644
index 0000000..c437d28
--- /dev/null
+++ b/etc/mock/clear.cfg
@@ -0,0 +1,37 @@
+config_opts['root'] = 'clear'
+config_opts['target_arch'] = 'x86_64'
+config_opts['legal_host_arches'] = ('x86_64',)
+config_opts['chroot_setup_cmd'] = 'groupinstall build srpm-build'
+config_opts['dist'] = 'clear'  # only useful for --resultdir variable subst
+config_opts['extra_chroot_dirs'] = [ '/run/lock', ]
+config_opts['useradd'] = '/usr/sbin/useradd -m -u %(uid)s -g %(gid)s -d %(home)s  %(user)s'
+config_opts['plugin_conf']['ccache_enable'] = False
+config_opts['releasever'] = 'clear'
+config_opts['package_manager'] = 'dnf'
+
+config_opts['yum.conf'] = """
+[main]
+cachedir=/var/cache/yum
+debuglevel=1
+reposdir=/dev/null
+logfile=/var/log/yum.log
+retries=20
+obsoletes=1
+gpgcheck=0
+assumeyes=1
+syslog_ident=mock
+syslog_device=
+# repos
+[clearlinux]
+name=clearlinux
+baseurl=https://cdn.download.clearlinux.org/current/x86_64/os/
+gpgcheck=0
+cost=2000
+enabled=1
+[debuginfo]
+name=debuginfo
+baseurl=https://cdn.download.clearlinux.org/current/x86_64/debug/
+gpgcheck=0
+cost=2000
+enabled=1
+"""
diff --git a/py/mock.py b/py/mock.py
index 0b68d38..71d59e4 100755
--- a/py/mock.py
+++ b/py/mock.py
@@ -59,6 +59,7 @@ SYSCONFDIR = os.path.join(os.path.dirname(os.path.realpath(sys.argv[0])), "..",
 PYTHONDIR = os.path.dirname(os.path.realpath(sys.argv[0]))
 PKGPYTHONDIR = os.path.join(os.path.dirname(os.path.realpath(sys.argv[0])), "mockbuild")
 MOCKCONFDIR = os.path.join(SYSCONFDIR, "mock")
+DEFAULTMOCKCONFDIR = "/usr/share/defaults/mock"
 # end build system subs
 
 # import all mockbuild.* modules after this.
@@ -353,6 +354,8 @@ def setup_logging(config_path, config_opts, options):
             if os.path.normpath('/etc/mock') != os.path.normpath(config_path):
                 log.warning("Could not find required logging config file: %s. Using default..." % log_ini)
                 log_ini = os.path.join("/etc/mock", config_opts["log_config_file"])
+                if not os.path.exists(log_ini):
+                    log_ini = config_opts["log_config_file"]
                 if not os.path.exists(log_ini):
                     raise IOError("Could not find log config file %s" % log_ini)
             else:
@@ -580,7 +583,9 @@ def main():
         options.verbose = 0
 
     # config path -- can be overridden on cmdline
-    config_path = MOCKCONFDIR
+    config_path = DEFAULTMOCKCONFDIR
+    if os.path.exists(MOCKCONFDIR):
+        config_path = MOCKCONFDIR
     if options.configdir:
         config_path = options.configdir
 
diff --git a/py/mockbuild/util.py b/py/mockbuild/util.py
index d868a33..92569a6 100644
--- a/py/mockbuild/util.py
+++ b/py/mockbuild/util.py
@@ -652,7 +652,7 @@ def setup_default_config_opts(unprivUid, version, pkgpythondir):
     config_opts['check'] = True
     config_opts['post_install'] = False
     config_opts['chroothome'] = '/builddir'
-    config_opts['log_config_file'] = 'logging.ini'
+    config_opts['log_config_file'] = '/usr/share/defaults/mock/logging.ini'
     config_opts['rpmbuild_timeout'] = 0
     config_opts['chrootuid'] = unprivUid
     try:
@@ -1068,7 +1068,7 @@ def load_config(config_path, name, uidManager, version, PKGPYTHONDIR):
     config_opts['config_file'] = chroot_cfg_path
 
     cfg = os.path.join(config_path, 'site-defaults.cfg')
-    do_update_config(log, config_opts, cfg, uidManager, name)
+    do_update_config(log, config_opts, cfg, uidManager, name, skipError=True)
 
     do_update_config(log, config_opts, chroot_cfg_path, uidManager, name, skipError=False)
 
-- 
2.16.1

